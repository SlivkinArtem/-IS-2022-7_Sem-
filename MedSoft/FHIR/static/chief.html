<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Hospital Chief • FHIR</title>
  <link rel="stylesheet" href="/static/style.css"/>
</head>
<body>
<div class="container">
  <h1>Пациенты (live, из Chief)</h1>
  <div class="card">
    <span class="pill" id="state">WS: …</span>
    <div class="table-wrap mt-12">
      <table>
        <thead>
          <tr>
            <th>ID</th><th>Фамилия</th><th>Имя</th><th>Дата рождения</th><th>FHIR id</th><th>Действия</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
async function deletePatient(id){
  if(!confirm(`Удалить пациента #${id}?`)) return;
  try{
    const res = await fetch(`/api/patient/${id}`, { method: 'DELETE' });
    if(!res.ok){
      const {detail} = await res.json().catch(()=>({detail:'unknown error'}));
      alert('Ошибка: ' + detail);
      return;
    }
  }catch(e){
    alert('Сеть/SSL: ' + e);
  }
}
const rows  = document.getElementById('rows');
const state = document.getElementById('state');

function connect(){
  const ws = new WebSocket(`${location.protocol === 'https:' ? 'wss' : 'ws'}://${location.host}/ws/chief`);
  ws.onopen  = ()=> state.textContent='WS: connected';
  ws.onclose = ()=> { state.textContent='WS: closed'; setTimeout(connect, 1000) };
  ws.onmessage = (ev)=>{
    const msg = JSON.parse(ev.data);
    if (msg.type === 'patients') {
      rows.innerHTML = '';
      msg.data.forEach(p=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.id}</td>
          <td>${p.last_name}</td>
          <td>${p.first_name}</td>
          <td>${p.dob}</td>
          <td class="mono">${p.fhir_id}</td>
          <td><button class="btn-secondary" onclick="deletePatient(${p.id})">Удалить</button></td>
        `;
        rows.appendChild(tr);
      });
      try { ws.send('ok'); } catch(e){}
    }
  };
}
connect();
</script>
</body>
</html>